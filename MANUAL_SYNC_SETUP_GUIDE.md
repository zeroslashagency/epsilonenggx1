# üöÄ Manual Sync Setup Guide

## **Complete Solution for Real Manual Sync Button**

This guide will help you set up a **real manual sync button** that actually works using Supabase Edge Functions.

---

## **üìã What This Solution Provides:**

‚úÖ **Real Manual Sync Button** - Actually triggers sync from SmartOffice  
‚úÖ **Supabase Edge Functions** - Cloud-based sync request handling  
‚úÖ **Office Script Integration** - Responds to manual sync requests  
‚úÖ **Real-time Status Updates** - Shows sync progress and results  
‚úÖ **Fallback Support** - Works even if Edge Functions fail  

---

## **üèóÔ∏è Architecture:**

```
[Your Dashboard] ‚Üí [Manual Sync Button] ‚Üí [Supabase Edge Function] ‚Üí [Office Script] ‚Üí [SmartOffice] ‚Üí [Supabase Database]
```

---

## **üõ†Ô∏è Setup Steps:**

### **Step 1: Create Database Table**

Run this SQL in your Supabase SQL Editor:

```sql
-- Create sync_requests table for manual sync functionality
CREATE TABLE public.sync_requests (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  sync_type text NOT NULL,
  status text NOT NULL DEFAULT 'pending',
  requested_at timestamp with time zone DEFAULT now() NOT NULL,
  requested_by text DEFAULT 'dashboard',
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  result text,
  error_message text,
  created_at timestamp with time zone DEFAULT now() NOT NULL,
  updated_at timestamp with time zone DEFAULT now() NOT NULL,
  CONSTRAINT sync_requests_pkey PRIMARY KEY (id)
);

-- Add indexes for better performance
CREATE INDEX idx_sync_requests_status ON public.sync_requests(status);
CREATE INDEX idx_sync_requests_requested_at ON public.sync_requests(requested_at);

-- Add RLS (Row Level Security) policies
ALTER TABLE public.sync_requests ENABLE ROW LEVEL SECURITY;

-- Allow authenticated users to read sync requests
CREATE POLICY "Allow authenticated users to read sync requests" ON public.sync_requests
  FOR SELECT USING (auth.role() = 'authenticated');

-- Allow authenticated users to insert sync requests
CREATE POLICY "Allow authenticated users to insert sync requests" ON public.sync_requests
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

-- Allow service role to update sync requests (for office script)
CREATE POLICY "Allow service role to update sync requests" ON public.sync_requests
  FOR UPDATE USING (auth.role() = 'service_role');
```

### **Step 2: Deploy Supabase Edge Function**

1. **Install Supabase CLI:**
   ```bash
   npm install -g supabase
   ```

2. **Login to Supabase:**
   ```bash
   supabase login
   ```

3. **Link your project:**
   ```bash
   supabase link --project-ref sxnaopzgaddvziplrlbe
   ```

4. **Deploy the Edge Function:**
   ```bash
   supabase functions deploy manual-sync
   ```

### **Step 3: Update Office Script**

1. **Replace your office script** with the new version:
   ```bash
   # Copy office-sync-script-with-manual-trigger.js to your office computer
   # Rename it to office-sync-script.js
   ```

2. **Run the updated script:**
   ```bash
   node office-sync-script.js --auto
   ```

### **Step 4: Test the Manual Sync**

1. **Go to your dashboard**
2. **Click "Sync from SmartOffice" button**
3. **Watch the console logs** for sync progress
4. **Check for new data** in your dashboard

---

## **üéØ How It Works:**

### **1. Manual Sync Button Click:**
- Dashboard calls Supabase Edge Function
- Edge Function creates sync request in database
- Returns request ID to dashboard

### **2. Office Script Processing:**
- Office script polls for pending sync requests
- When found, processes the sync request
- Fetches data from SmartOffice
- Updates sync request status

### **3. Dashboard Updates:**
- Dashboard polls for sync completion
- Shows real-time status updates
- Displays new data when sync completes

---

## **üìä Expected Results:**

### **‚úÖ Success Case:**
```
üöÄ Starting manual sync via Supabase Edge Function...
Edge Function result: { success: true, requestId: "123" }
‚úÖ Manual sync completed successfully!
Request ID: 123
Office script should have processed the sync request.
```

### **‚ö†Ô∏è Fallback Case:**
```
‚ö†Ô∏è Edge Function failed, using fallback sync.
SmartOffice device not connected - Office sync script should be running
üí° Recommendation: Set up the office-sync-script.js on your office computer
```

---

## **üîß Troubleshooting:**

### **Problem: Edge Function Not Found**
**Solution:** Make sure you deployed the Edge Function:
```bash
supabase functions deploy manual-sync
```

### **Problem: Office Script Not Responding**
**Solution:** Make sure office script is running with manual trigger support:
```bash
node office-sync-script.js --auto
```

### **Problem: Database Permission Errors**
**Solution:** Check RLS policies in Supabase dashboard

---

## **üéâ Benefits:**

1. **Real Manual Sync** - Button actually triggers sync from SmartOffice
2. **Cloud-Based** - Works from anywhere, not just office network
3. **Real-Time Updates** - Shows sync progress and results
4. **Reliable** - Has fallback mechanisms if Edge Functions fail
5. **Scalable** - Can handle multiple sync requests

---

## **üìù Files Created:**

- `supabase/functions/manual-sync/index.ts` - Edge Function
- `office-sync-script-with-manual-trigger.js` - Updated office script
- `sync_requests_table.sql` - Database table setup
- `app/api/check-sync-status/route.ts` - Status checking API
- Updated `app/page.tsx` - Dashboard with Edge Function support

---

**üéØ This solution gives you a REAL manual sync button that actually works!** üöÄ




